    handleCopy(e){
      function processDiv(div){
        // 处理所有katex元素
        const processedKatex = div.querySelectorAll('.katex');
        processedKatex.forEach(katex => {
            const annotation = katex.querySelector('annotation');
            if (annotation) {
                const textNode = document.createTextNode(' $' + annotation.textContent + '$ ');
                katex.parentNode.replaceChild(textNode, katex);
            }
        });
      }

      // 获取选中的范围
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      
      // 创建一个文档片段用于处理
      const range = selection.getRangeAt(0);
      const fragment = range.cloneContents();
      
      // 检查是否有katex元素需要处理
      const katexElements = fragment.querySelectorAll('.katex');
      if (katexElements.length === 0) return;
      
      // 阻止默认复制行为
      e.preventDefault();

      const textDiv = document.createElement('div');
      textDiv.appendChild(fragment.cloneNode(true));
      processDiv(textDiv)

      let htmlContent = textDiv.innerHTML
      let textContent = textDiv.textContent
          .replace(/\s+/g, ' ')      // 合并多个空格
          .replace(/\$ /g, '$ ')      // 清理公式后的空格
          .replace(/ \$/g, ' $')      // 清理公式前的空格
          .trim();
      
      const clipboardData = e.clipboardData || window.clipboardData;
      clipboardData.setData('text/html', htmlContent);
      clipboardData.setData('text/plain', textContent);
      

    },

    handleCopy(e){
      // 获取选中的范围
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      
      // 创建一个文档片段用于处理
      const range = selection.getRangeAt(0);
      const fragment = range.cloneContents();
      
      // 检查是否有katex元素需要处理
      const katexElements = fragment.querySelectorAll('.katex');
      if (katexElements.length === 0) return;
      
      // 阻止默认复制行为
      e.preventDefault();
      
      // 创建临时容器
      const tempDiv = document.createElement('div');
      tempDiv.appendChild(fragment.cloneNode(true));
      
      // 处理所有katex元素
      const processedKatex = tempDiv.querySelectorAll('.katex');
      processedKatex.forEach(katex => {
          const annotation = katex.querySelector('annotation');
          if (annotation) {
              // 使用特殊标记代替换行符，稍后再恢复
              let katex_flag_l = katex.tagName==='P'?'[NEWLINE]$$[NEWLINE]':' $'
              let katex_flag_r = katex.tagName==='P'?'[NEWLINE]$$[NEWLINE]':'$ '
              katex.textContent = katex_flag_l + annotation.textContent + katex_flag_r;
          }
      });

      // 获取处理后的文本内容
      let textToCopy = tempDiv.textContent;
      // 清理文本
      textToCopy = textToCopy
          .replace(/\s+/g, ' ')      // 合并多个空格
          .replace(/\$ /g, '$ ')      // 清理公式后的空格
          .replace(/ \$/g, ' $')      // 清理公式前的空格
          .replace(/\[NEWLINE\]/g, '\n')  // 恢复换行符
          .trim();

      this.copyToClipboard(textToCopy);

    },


    handleAiSave() {
      // 序列化为JSON字符串
      const jsonStr = JSON.stringify(this.ai_res)
      
      // 创建Blob对象
      const blob = new Blob([jsonStr], { type: 'application/json' })
      
      // 创建下载链接
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = 'SAVE_' + this.generateString() + '_AI.json'
      
      // 触发下载
      document.body.appendChild(a)
      a.click()
      
      // 清理
      setTimeout(() => {
        document.body.removeChild(a)
        URL.revokeObjectURL(url)
      }, 100)
    },
    // 处理文件拖拽
    handleAiDrop(event) {
      const file = event.dataTransfer.files[0]
      if (!file || !file.name.endsWith('.json')) {
        return
      }
      
      const reader = new FileReader()
      reader.onload = (e) => {
        const content = e.target.result
        const parsedData = JSON.parse(content)
        const isValid = parsedData.every(item => 
          item && typeof item.text === 'string' && typeof item.dt === 'string'
        )
        if(isValid){
          this.ai_res = parsedData
        }
        
      }
      reader.readAsText(file)
    },